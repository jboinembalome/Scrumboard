@if (card) {
  <div class="absolute inset-0 flex flex-row h-full overflow-y-hidden text-gray-900 dark:text-gray-100">
    <div class="grow overflow-auto">
      <div class="flex-col">
        <!-- TODO: Truncate breadcrumb (depending of text size) -->
        <!-- Breadcrumbs -->
        <div class="flex flex-0 sticky px-4 border-b border-gray-300 dark:border-gray-700 top-0 z-40 w-full backdrop-blur flex-none transition-colors duration-500 bg-white/75 dark:bg-gray-950/75">
          <app-breadcrumb [items]="breadcrumbItems"></app-breadcrumb>
        </div>
        <div class="relative flex gap-4 overflow-auto">
          <!-- Card form -->
          <form class="flex flex-col overflow-auto flex-0 items-start w-5/6 mx-auto p-2 space-y-1" [formGroup]="cardForm">
            <!-- Name -->
            <div class="w-full">
              <div class="flex items-center justify-between pb-1">
                <div class="flex items-center">
                  <mat-icon class="mr-4 text-primary">edit</mat-icon>
                  <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
                    Name*</p>
                </div>
              </div>
              <mat-form-field class="w-full" appearance="outline">
                <textarea matInput class="text-gray-900 dark:text-gray-100" [formControlName]="'name'" [rows]="1"
                  cdkTextareaAutosize cdkAutosizeMinRows="1">
                </textarea>
                <mat-error>Name is required.</mat-error>
              </mat-form-field>
            </div>
    
            <!-- End date -->
            <!-- TODO: Use mat-calendar and mat-menu (mat-form-field should be inside the form) -->
            <mat-form-field class="w-0 h-0 invisible">
              <input matInput [matDatepicker]="endDatePicker" [formControlName]="'dueDate'">
            </mat-form-field>

            <!-- Description -->
            <div class="w-full">
              <div class="flex items-center justify-between pb-1">
                <div class="flex items-center">
                  <mat-icon class="mr-4 text-primary">description</mat-icon>
                  <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
                    Description</p>
                </div>
              </div>
              <mat-form-field class="w-full" appearance="outline">
                <textarea matInput class="text-gray-900 dark:text-gray-100" [formControlName]="'description'" [rows]="6"
                  cdkTextareaAutosize cdkAutosizeMinRows="1">
                </textarea>
              </mat-form-field>
            </div>
    
            <!-- Checklists -->
              @if (card.checklists.length > 0) {
                <div class="w-full pb-8">
                  <checklists [checklists]="card.checklists" (checklistsUpdated)="updateChecklists($event)"></checklists>
                </div>
              }
            
    
            <!-- Add Comment -->
            <div class="w-full pb-4">
              <div class="flex items-center justify-between pb-1">
                <div class="flex items-center">
                  <mat-icon class="mr-4 text-primary">comment</mat-icon>
                  <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
                    Comments</p>
                </div>
              </div>
              <comment-add [card]="card" (commentAdded)="addComment($event)"></comment-add>
            </div>
    
            <!-- Comments -->
              @if (card.comments.length > 0) {
              <div class="w-full">
                <comments [cardId]="card.id" [comments]="comments" (commentsUpdated)="updateComments($event)"></comments>
              </div>
              }
            
    
            <!-- Activities -->
            <div class="w-full pt-1">
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <mat-icon class="mr-4 text-primary">list</mat-icon>
                  <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
                    Activity</p>
                </div>
                <button type="button" (click)="toogleActivities()"
                  class="inline-flex items-center justify-center relative px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 ">
                  <mat-icon class="mr-1">history</mat-icon>
                  {{!showActivities ? 'Show': 'Hide'}}
                </button>
              </div>
              @if (showActivities) {
                <div class="w-full">
                  @if (activitiesEmitter$ | async; as activities) {
                    <activities [activities]="activities"></activities>
                  }
                  @else {
                    <div class="p-8 text-2xl font-semibold text-center">There are no activities!</div>
                  }
                </div>
              }
            </div>
          </form>    
        </div>
      </div>
    </div>

    <!-- TODO: Add Properties on mobile -->
    <!-- Properties -->
    <div class="hidden sm:block flex-none w-64 lg:w-80 pt-2 px-4 border-l border-gray-300 dark:border-gray-700">
      <div class="flex-row space-y-2">
        <!-- Assignees -->
        <div>
          <div class="flex items-center mb-2">
            <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
              Assignees</p>
          </div>

         
          <div class="w-full" [class.hidden]="card.assignees.length === 0">
              <mat-chip-set 
                #assigneeChipList 
                aria-label="Assignee selection">
                @for (assignee of card.assignees; track $index) {
                  <mat-chip
                    (removed)="removeMemberChip(assignee)">
                    <img
                      matChipAvatar
                      [src]="assignee.hasAvatar 
                              ? urlAvatar + assignee.id 
                              : 'assets/images/avatars/profile.jpg'"
                      class="rounded-full" />
                    {{assignee.firstName}}
                    <button matChipRemove>
                      <mat-icon>cancel</mat-icon>
                    </button>
                    
                  </mat-chip>
                }
                
                <mat-chip 
                  [matMenuTriggerFor]="assigneeMenu" 
                  #assigneeMenuTrigger="matMenuTrigger">
                  <mat-icon class="flex">add</mat-icon>
                </mat-chip>
              </mat-chip-set>            
          </div>
        
        
          <button type="button" [matMenuTriggerFor]="assigneeMenu" #assigneeMenuTrigger="matMenuTrigger"
            class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 dark:text-primary-100 hover:bg-primary-600 dark:hover:bg-primary-800 hover:text-white"
            [class.hidden]="card.assignees.length > 0">
            <mat-icon class="mr-1">person</mat-icon>
            Set assignees
          </button>
          
          <mat-menu #assigneeMenu="matMenu" xPosition="after" yPosition="below" class="dark:bg-gray-900">
            <div class="p-4 flex flex-col gap-2 max-h-48 leading-none overflow-y-auto" (click)="$event.stopPropagation()">
  
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Members</label>
              <!-- Members -->
              <user-selector [selectedUsers]="card.assignees" [users]="allMembers"
                (userUpdated)="updateMembers($event)">
              </user-selector>
            </div>
          </mat-menu>
        </div>
        
        
        <!-- End date-->
        <div>
          <div class="flex items-center mb-2">
            <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
              End date</p>
          </div>

          @if (card.dueDate) {          
            <mat-chip
              (removed)="endDatePicker.select(null)"
              (click)="endDatePicker.open()"
              [ngClass]="{'text-green-800 bg-green-200 dark:text-green-100 dark:bg-green-500': card.dueDate && !isOverdue(card.dueDate),
                              'text-red-800 bg-red-200 dark:text-red-100 dark:bg-red-500': card.dueDate && isOverdue(card.dueDate)}">
              {{card.dueDate | date:'longDate'}}
              <button matChipRemove>
                <mat-icon>cancel</mat-icon>
              </button>
            </mat-chip>
          }
          @else {
            <button type="button" (click)="endDatePicker.open()"
              class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 dark:text-primary-100 hover:bg-primary-600 dark:hover:bg-primary-800 hover:text-white">
              <mat-icon class="mr-1">event</mat-icon>
              Set end date
            </button>
          }

          <mat-datepicker #endDatePicker>
            <mat-datepicker-actions>
              <button type="button" matDatepickerApply
                class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded text-indigo-100 bg-indigo-600 hover:bg-indigo-700 ">
                <mat-icon class="mr-2">save</mat-icon>
                Save
              </button>
              <button type="button" matDatepickerCancel (click)="dueDatePicker.select(null)"
                class="inline-flex items-center px-4 py-2 ml-3 border border-transparent shadow-sm text-sm font-medium rounded text-indigo-100 bg-indigo-600 hover:bg-indigo-700 ">
                <mat-icon class="mr-2">delete</mat-icon>
                Remove
              </button>
            </mat-datepicker-actions>
          </mat-datepicker>
        </div>


        <!-- Labels -->
        <div>
          <div class="flex items-center mb-2">
            <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
              Labels</p>
          </div>

          
          <div class="w-full" [class.hidden]="card.labels.length === 0">
              <mat-chip-set  #chipList aria-label="label selection">
                @for (label of card.labels; track $index) {
                  <mat-chip
                    (removed)="removeLabelChip(label)" 
                    class="text-indigo-100" 
                    [ngClass]="label.colour.colour">
                    {{label.name}}
                    <button matChipRemove>
                      <mat-icon>cancel</mat-icon>
                    </button>
                  </mat-chip>
                }

                <mat-chip
                  [matMenuTriggerFor]="labelMenu" 
                  #labelMenuTrigger="matMenuTrigger">
                  <mat-icon class="flex">add</mat-icon>
                </mat-chip>
                
              </mat-chip-set>
          </div>
    
          <button type="button" [matMenuTriggerFor]="labelMenu" #labelMenuTrigger="matMenuTrigger"
            class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 dark:text-primary-100 hover:bg-primary-600 dark:hover:bg-primary-800 hover:text-white"
            [class.hidden]="card.labels.length > 0">
            <mat-icon class="mr-1">label</mat-icon>
            Set Labels
          </button>

          <mat-menu #labelMenu="matMenu" [overlapTrigger]="false" class="dark:bg-gray-900">
            <div class="p-4 flex flex-col gap-2 max-h-48 leading-none overflow-y-auto" (click)="$event.stopPropagation()">
  
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-200">Labels</label>
              <!-- Labels -->
              <label-selector [selectedLabels]="card.labels" [labels]="allLabels" (labelUpdated)="updateLabels($event)"
                (labelCompletelyDeleted)="deletedLabelFromCtrl($event)">
              </label-selector>
  
              <mat-divider class="my-2"></mat-divider>
  
              <!-- Label Form -->
              <label-add (labelAdded)="addLabel($event)" (labelCanceled)="labelMenuTrigger.closeMenu()"
                (click)="$event.stopPropagation()"></label-add>
            </div>
          </mat-menu>
        </div>
      
        
        <!-- Checklists -->
        <div>
          <div class="flex items-center mb-2">
            <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
              Checklists</p>
          </div>
          <button type="button" [matMenuTriggerFor]="checklistMenu" #checklistMenuTrigger="matMenuTrigger"
            class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 dark:text-primary-100 hover:bg-primary-600 dark:hover:bg-primary-800 hover:text-white">
            <mat-icon class="mr-1">checklist</mat-icon>
            Add checklist
          </button>
          <mat-menu #checklistMenu="matMenu" [overlapTrigger]="false" class="dark:bg-gray-900">
            <!-- Checklist Form -->
            <checklist-add (checklistAdded)="addChecklist($event)" (checklistCanceled)="checklistMenuTrigger.closeMenu()"
              (click)="$event.stopPropagation()">
            </checklist-add>
          </mat-menu>
        </div>
        
        
        <!-- Actions -->
        <div>
          <div class="flex items-center mb-2">
            <p class="block m-0 text-sm font-medium text-gray-700 dark:text-gray-200">
              Actions</p>
          </div>
        </div>
        <button type="button" (click)="deleteCard(card)"
          class="w-full inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-primary-600 dark:text-primary-100 hover:bg-primary-600 dark:hover:bg-primary-800 hover:text-white">
          <mat-icon class="mr-1">delete</mat-icon>
          Remove Card
        </button>
      </div>
    </div>
  </div>
}